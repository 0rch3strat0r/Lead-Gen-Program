<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>User Dashboard</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 16px; margin-top: 16px; }
    input, button, select { padding: 8px; }
    pre { background: #f6f8fa; padding: 12px; border-radius: 6px; white-space: pre-wrap; }
    label { font-size: 12px; color: #555; display: block; }
  </style>
</head>
<body>
  <h1>User Dashboard</h1>

  <div class="card">
    <h3>Headers (saved locally)</h3>
    <div class="row">
      <div>
        <label>x-user-id</label>
        <input id="xUserId" placeholder="user-456" />
      </div>
      <div>
        <label>x-client-id</label>
        <input id="xClientId" placeholder="tenant UUID" />
      </div>
      <button id="btnSaveHeaders">Save</button>
      <button id="btnCheckMe">Check Role (/api/me)</button>
    </div>
    <pre id="meOut"></pre>
  </div>

  <div class="card">
    <h3>Opportunities</h3>
    <div class="row">
      <button id="btnListOpps">List My Tenant Opportunities</button>
    </div>
    <pre id="oppsOut"></pre>
  </div>

  <div class="card">
    <h3>Claim Opportunity</h3>
    <div class="row">
      <input id="oppId" placeholder="Opportunity ID" style="min-width:260px" />
      <button id="btnClaim">Claim</button>
    </div>
    <pre id="claimOut"></pre>
  </div>

  <div class="card">
    <h3>Download Sheets</h3>
    <div class="row">
      <input id="dlOppId" placeholder="Opportunity ID" style="min-width:260px" />
      <button id="btnDlBrief">Download Executive Brief</button>
      <button id="btnDlCheat">Download Cheat Sheet</button>
    </div>
    <pre id="dlOut"></pre>
  </div>

<script>
function loadHeaders() {
  document.getElementById('xUserId').value = localStorage.getItem('x-user-id') || '';
  document.getElementById('xClientId').value = localStorage.getItem('x-client-id') || '';
}
function saveHeaders() {
  localStorage.setItem('x-user-id', document.getElementById('xUserId').value.trim());
  localStorage.setItem('x-client-id', document.getElementById('xClientId').value.trim());
}
function headers() {
  const h = { 'content-type': 'application/json' };
  const uid = localStorage.getItem('x-user-id');
  const cid = localStorage.getItem('x-client-id');
  if (uid) h['x-user-id'] = uid;
  if (cid) h['x-client-id'] = cid;
  return h;
}

async function checkMe() {
  const r = await fetch('/api/me', { headers: headers() });
  const j = await r.json();
  document.getElementById('meOut').textContent = JSON.stringify(j, null, 2);
}

async function listOpps() {
  const r = await fetch('/api/opportunities/list', { headers: headers() });
  const j = await r.json();
  document.getElementById('oppsOut').textContent = JSON.stringify(j, null, 2);
}

async function claimOpp() {
  const id = document.getElementById('oppId').value.trim();
  if (!id) { document.getElementById('claimOut').textContent = 'Enter an opportunity id'; return; }
  const payload = { id, userId: localStorage.getItem('x-user-id') || '' };
  const r = await fetch('/api/opportunities/claim', { method:'POST', headers: headers(), body: JSON.stringify(payload) });
  const j = await r.json();
  document.getElementById('claimOut').textContent = JSON.stringify(j, null, 2);
}

async function downloadFile(url, filename) {
  const r = await fetch(url, { headers: headers() });
  if (!r.ok) {
    const t = await r.text();
    document.getElementById('dlOut').textContent = `Error ${r.status}: ${t}`;
    return;
  }
  const blob = await r.blob();
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}
async function downloadBrief() {
  const id = document.getElementById('dlOppId').value.trim();
  if (!id) { document.getElementById('dlOut').textContent = 'Enter an opportunity id'; return; }
  await downloadFile(`/api/opportunities/sheet/opportunity?id=${encodeURIComponent(id)}`, `opportunity_${id}.html`);
}
async function downloadCheat() {
  const id = document.getElementById('dlOppId').value.trim();
  if (!id) { document.getElementById('dlOut').textContent = 'Enter an opportunity id'; return; }
  await downloadFile(`/api/opportunities/sheet/cheatsheet?id=${encodeURIComponent(id)}`, `cheatsheet_${id}.html`);
}

document.getElementById('btnSaveHeaders').addEventListener('click', () => { saveHeaders(); checkMe(); });
document.getElementById('btnCheckMe').addEventListener('click', checkMe);
document.getElementById('btnListOpps').addEventListener('click', listOpps);
document.getElementById('btnClaim').addEventListener('click', claimOpp);
document.getElementById('btnDlBrief').addEventListener('click', downloadBrief);
document.getElementById('btnDlCheat').addEventListener('click', downloadCheat);

loadHeaders();
checkMe();
</script>
</body>
</html>