<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 16px; margin-top: 16px; }
    input, button, select, textarea { padding: 8px; }
    pre { background: #f6f8fa; padding: 12px; border-radius: 6px; white-space: pre-wrap; }
    label { font-size: 12px; color: #555; display: block; }
  </style>
</head>
<body>
  <h1>Admin Dashboard</h1>

  <div class="card">
    <h3>Headers (saved locally)</h3>
    <div class="row">
      <div>
        <label>x-user-id</label>
        <input id="xUserId" placeholder="user-123" />
      </div>
      <div>
        <label>x-client-id</label>
        <input id="xClientId" placeholder="tenant UUID" />
      </div>
      <button id="btnSaveHeaders">Save</button>
      <button id="btnCheckMe">Check Role (/api/me)</button>
    </div>
    <pre id="meOut"></pre>
  </div>

  <div class="card">
    <h3>Run Research (admin only)</h3>
    <div class="row">
      <input id="companyName" placeholder="Company Name" />
      <input id="companyUrl" placeholder="https://example.com" style="min-width:280px" />
    </div>
    <div class="row" style="margin-top:8px;">
      <label>Notes (JSON or text)</label>
      <textarea id="notes" rows="3" style="min-width:460px"></textarea>
    </div>
    <div class="row" style="margin-top:8px;">
      <button id="btnRunResearch">Run Research</button>
      <button id="btnListResearch">List Research Jobs</button>
    </div>
    <pre id="researchOut"></pre>
  </div>

  <div class="card">
    <h3>Opportunities</h3>
    <div class="row">
      <button id="btnListOpps">List Opportunities</button>
      <label>Quick Create</label>
      <input id="oppTitle" placeholder="Title" />
      <input id="oppUrl" placeholder="https://company.com/path" style="min-width:280px" />
      <select id="oppRegion">
        <option value="nyc">NYC</option>
        <option value="la">LA</option>
        <option value="chi">Chicago</option>
        <option value="dal">Dallas</option>
        <option value="mia">Miami</option>
        <option value="sea">Seattle</option>
      </select>
      <button id="btnCreateOpp">Create</button>
    </div>
    <pre id="oppsOut"></pre>
  </div>

  <div class="card">
    <h3>Assign / Unassign</h3>
    <div class="row">
      <input id="assignOppId" placeholder="Opportunity ID" style="min-width:260px" />
      <input id="assigneeUserId" placeholder="Assignee User ID (e.g., user-456)" style="min-width:260px" />
      <button id="btnAssign">Assign</button>
      <button id="btnUnassign">Unassign</button>
    </div>
    <pre id="assignOut"></pre>
  </div>

  <div class="card">
    <h3>Update Stage / Amounts</h3>
    <div class="row">
      <input id="updOppId" placeholder="Opportunity ID" style="min-width:240px" />
      <input id="updStage" placeholder="stage (e.g., discovered, qualified, contacted, proposal, negotiation, closed)" style="min-width:520px" />
    </div>
    <div class="row" style="margin-top:8px;">
      <input id="updEstMvp" placeholder="est_mvp_value" />
      <input id="updEstContract" placeholder="est_contract_value" />
      <input id="updAgreedMvp" placeholder="agreed_mvp_value" />
      <input id="updAgreedContract" placeholder="agreed_contract_value" />
      <button id="btnUpdateOpp">Update</button>
    </div>
    <pre id="updateOut"></pre>
  </div>

<script>
function loadHeaders() {
  document.getElementById('xUserId').value = localStorage.getItem('x-user-id') || 'user-123';
  document.getElementById('xClientId').value = localStorage.getItem('x-client-id') || '';
}
function saveHeaders() {
  localStorage.setItem('x-user-id', document.getElementById('xUserId').value.trim());
  localStorage.setItem('x-client-id', document.getElementById('xClientId').value.trim());
}
function headers() {
  const h = { 'content-type': 'application/json' };
  const uid = localStorage.getItem('x-user-id');
  const cid = localStorage.getItem('x-client-id');
  if (uid) h['x-user-id'] = uid;
  if (cid) h['x-client-id'] = cid;
  return h;
}

async function checkMe() {
  const r = await fetch('/api/me', { headers: headers() });
  const j = await r.json();
  document.getElementById('meOut').textContent = JSON.stringify(j, null, 2);
}

async function runResearch() {
  const payload = {
    companyName: document.getElementById('companyName').value,
    companyUrl: document.getElementById('companyUrl').value,
    notes: document.getElementById('notes').value
  };
  const r = await fetch('/api/research/run', {
    method: 'POST', headers: headers(), body: JSON.stringify(payload)
  });
  const j = await r.json();
  document.getElementById('researchOut').textContent = JSON.stringify(j, null, 2);
}

async function listResearch() {
  const r = await fetch('/api/research/list', { headers: headers() });
  const j = await r.json();
  document.getElementById('researchOut').textContent = JSON.stringify(j, null, 2);
}

async function listOpps() {
  const r = await fetch('/api/opportunities/list', { headers: headers() });
  const j = await r.json();
  document.getElementById('oppsOut').textContent = JSON.stringify(j, null, 2);
}

async function createOpp() {
  const payload = {
    title: document.getElementById('oppTitle').value,
    url: document.getElementById('oppUrl').value,
    regionCode: document.getElementById('oppRegion').value
  };
  const r = await fetch('/api/opportunities/create', {
    method: 'POST', headers: headers(), body: JSON.stringify(payload)
  });
  const j = await r.json();
  document.getElementById('oppsOut').textContent = JSON.stringify(j, null, 2);
}

async function assignOpp() {
  const payload = {
    id: document.getElementById('assignOppId').value.trim(),
    assigneeUserId: document.getElementById('assigneeUserId').value.trim()
  };
  const r = await fetch('/api/opportunities/assign', { method:'POST', headers: headers(), body: JSON.stringify(payload) });
  const j = await r.json();
  document.getElementById('assignOut').textContent = JSON.stringify(j, null, 2);
}
async function unassignOpp() {
  const payload = { id: document.getElementById('assignOppId').value.trim() };
  const r = await fetch('/api/opportunities/unassign', { method:'POST', headers: headers(), body: JSON.stringify(payload) });
  const j = await r.json();
  document.getElementById('assignOut').textContent = JSON.stringify(j, null, 2);
}
async function updateOpp() {
  const payload = { id: document.getElementById('updOppId').value.trim() };
  const stage = document.getElementById('updStage').value.trim();
  const est_mvp = document.getElementById('updEstMvp').value.trim();
  const est_contract = document.getElementById('updEstContract').value.trim();
  const agreed_mvp = document.getElementById('updAgreedMvp').value.trim();
  const agreed_contract = document.getElementById('updAgreedContract').value.trim();
  if (stage) payload.stage = stage;
  if (est_mvp) payload.est_mvp_value = Number(est_mvp);
  if (est_contract) payload.est_contract_value = Number(est_contract);
  if (agreed_mvp) payload.agreed_mvp_value = Number(agreed_mvp);
  if (agreed_contract) payload.agreed_contract_value = Number(agreed_contract);
  const r = await fetch('/api/opportunities/update', { method:'POST', headers: headers(), body: JSON.stringify(payload) });
  const j = await r.json();
  document.getElementById('updateOut').textContent = JSON.stringify(j, null, 2);
}

document.getElementById('btnSaveHeaders').addEventListener('click', () => { saveHeaders(); checkMe(); });

document.getElementById('btnCheckMe').addEventListener('click', checkMe);
document.getElementById('btnRunResearch').addEventListener('click', runResearch);
document.getElementById('btnListResearch').addEventListener('click', listResearch);
document.getElementById('btnListOpps').addEventListener('click', listOpps);
document.getElementById('btnCreateOpp').addEventListener('click', createOpp);
document.getElementById('btnAssign').addEventListener('click', assignOpp);
document.getElementById('btnUnassign').addEventListener('click', unassignOpp);
document.getElementById('btnUpdateOpp').addEventListener('click', updateOpp);

loadHeaders();
checkMe();
</script>
</body>
</html>